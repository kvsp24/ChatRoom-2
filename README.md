# ChatRoom Document (v1.0)

**due 12.23 23:59:59**

简单群聊软件实现

采用**增量开发**

尽可能实现更多的功能，不强求实现所有功能，但是尽量完整完成所有基本功能.

------

## 开发环境

### client 

- C++ 
- QT

### server

- C++
- Mysql

------

# TODO

首先需要设计

- [x] 报文格式(2018.12.13)
- [x] 数据库表(2018.12.13)

## 基本要求

- [ ] 用户登录
- [ ] 用户改密
- [ ] 重复登录，后者踢掉前者
- [ ] 可以看到在线的其他用户
- [ ] 可以向某一个人发送数据
- [ ] 可以向全体发送数据
- [ ] 可以传送文件
- [ ] server需要记录log
- [ ] client信息尽量存放在server端

安全

- [ ] 数据库password字段需要加密

## Bonus

- [ ] 可以传输jpg图片、git图片，要求能显示、有动画效果(3')
- [ ] client可以指定向哪些人发送消息(1')
- [ ] server的log采用xml格式(1')
- [ ] 修改用户设置(2')
- [ ] 采用OpenSSL(2')
- [ ] 完成手机端client(5')
- [ ] 其他特色功能可根据实际情况加分


## 问题

### Client 

- [ ] client收到数据后，如何反馈到GUI?

### Server

------

# 协议栈

一共四种报文：

- 报道包
  - client: 发送用户密码
  - server: accept/reject和原因
- 上线/下线包
  - 只有server对client. 给所有在线用户发
  - 类型:上线/下线
  - 附加用户信息

- 文本信息发送包
  - 参考sj作业课件
  - 文件包可以在**文件信息发送包**的类型里面

- 设置包
  - 双向，用于设置GUI
  - 传配置文件(config.json)

## 报文格式

**报头**格式

|大小 | 描述 |
|------|-------|
| 2B   | 报文大类型  |
| 2B   | 细分类型/应答类型 | 
| 4B   | 长度(**不包括报头长度**) |


### 报道包 

**client -> server**


|大小 | 数值 |  描述 |
|------|-------| -------|
| 2B   | 0x10  | 类型
| 2B   | 0x00  </br> 0x01   | 登录 </br> 注册 |
| 4B   |  |  长度 | 
| 32B  |  | 用户名
| 32B  |   | 密码


**server -> client**

|大小 | 数值 |  描述 |
|------|-------|-------|
| 2B   | 0x80  | 类型
| 2B   | 0x00  </br> 0x01  </br> 0x02  </br> 0x03 </br> 0x04 </br> 0x05  </br> 0x06  |登录/注册 成功 </br> 登录成功（但是踢了原来登陆的人） </br> 登录失败，密码错误 </br>登录失败，用户名不存在 </br>注册失败，用户名已存在 </br>注册失败，用户名不符合要求  </br>注册失败，密码不符合要求
| 4B   | | 长度| 
| 19B  | |上次登录时间 |
| 4B  | |用户数量 ***n*** |
| 33B * ***n*** |  |所有用户信息  |


### 上线/下线包

**server -> client**

|大小 | 数值 |  描述 |
|------|-------| -------|
| 2B   | 0x81  | 类型
| 2B   | 0x00  </br> 0x01  | 上线 </br>下线|
| 4B   | | 长度  |
| 32B   | |用户名  |


### 文本信息发送包

**client -> server**

报头:

|大小 | 数值 | 描述 |
|------|-------|-------|
| 2B   | 0x12  | 类型
| 2B   | 0x00  </br> 0x01  </br> 0x02  </br> 0x03  </br> 0x04  | 给1个或多个文本信息</br> 全体用户发文本</br>给1个或多个发文件 </br> 全体用户发文件 </br> 回看
| 4B   | |  长度 |


附加数据:

- 0x00 

|大小 | 描述 |
|------|-------|
| 4B   | 用户数量 ***n***  |
| 32B * ***n***   | 用户名 |
| to end   | 文本信息  |

- 0x01 

|大小 | 描述 |
|------|-------|
| to end   | msg 文本信息  |

- 0x02

|大小 | 描述 |
|------|-------|
| 4B   | 用户数量 ***n***  |
| 32B * ***n***   | 用户名 |
| 64B    | 文件名 |
| to end   | 文件信息  |

- 0x03

|大小 | 描述 |
|------|-------|
| 64B   | 文件名  |
| to end   | 文件信息  |

- 0x04
  
|大小 | 描述 |
|------|-------|
| 4B   | 要回看的长度  |

> 注：回看的数据来源是用户自己的`收发信息表`

**server -> client**

报头:

|大小 | 数值 | 描述 |
|------|-------|-------|
| 2B   | 0x82  | 类型
| 2B   | 0x00  </br> 0x01  </br> 0x02  | 文本消息 </br> 文件 </br> 清屏
| 4B   | |  长度 |
| 32B   |  | 用户名 |
| 19B   |  | 时间 |

附加信息

- 0x00

|大小 | 描述 |
|------|-------|
| to end   | msg 文本信息  |

- 0x01 

|大小 | 描述 |
|------|-------|
| 64B   | 文件名  |
| to end   | 文件信息  |

- 0x02

无附加数据


### 设置包

**client -> server** 

|大小 | 数值 | 描述 |
|------|-------|-------|
| 2B   | 0x13  | 类型
| 2B   | 0x00 | 填充 |
| 4B   | | 长度  |
| 32B   | | 用户名  |
| to end | | 配置文件(config) |

**server -> client**

|大小 | 数值 | 描述 |
|------|-------|-------|
| 2B   | 0x83  | 类型
| 2B   | 0x00 | 填充 |
| 4B   | | 长度  |
| 32B   | | 用户名  |
| to end | | 配置文件(config) |

------

# 数据库

## `用户信息表`

系统只需要一个表

|用户 | 密码 | 上次登录时间 |
|------|-------|------|
|zhongyuchen| xxxx | 2018.12.13 20:12 | 
|zhaiyuchen| xxxx | 2018.12.12 14:22| 
|liuyitao| xxxx | 2018.12.13 15:32| 


## `收发消息表`

**每个用户**都需要单独维护一个收发信息表，记录**所有**自己发出的或者是对方发过来的（包括自己未登录时别人发送的内容）

主要功能:

- 回看历史消息

e.g.

|时间 | 来源用户 | 内容 | 类型 |
|------|-------|------|------|
|2018.12.1 20:12 | zhongyuchen | hello | msg|
|2018.12.13 2:13| zhaiyuchen | 1.jpg | img|
|2018.12.13 13:44| liuyitao | 2.docx | doc |
